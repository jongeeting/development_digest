name: Generate Weekly Digest

on:
  # Run every Monday at 9 AM EST (14:00 UTC)
  schedule:
    - cron: '0 14 * * 1'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      days:
        description: 'Number of days to look back'
        required: false
        default: '7'
      min_units:
        description: 'Minimum number of units'
        required: false
        default: '1'
      html:
        description: 'Generate HTML output (better for Substack)'
        required: false
        type: boolean
        default: true

jobs:
  generate-digest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create digests directory
        run: mkdir -p digests

      - name: Generate digest
        run: |
          DAYS="${{ github.event.inputs.days || '7' }}"
          MIN_UNITS="${{ github.event.inputs.min_units || '1' }}"
          HTML="${{ github.event.inputs.html || 'true' }}"
          DATE=$(date +%Y-%m-%d)

          # Set file extension based on format
          if [ "$HTML" = "true" ]; then
            EXT="html"
            HTML_FLAG="--html"
          else
            EXT="md"
            HTML_FLAG=""
          fi

          python generate_digest.py \
            --days "$DAYS" \
            --min-units "$MIN_UNITS" \
            $HTML_FLAG \
            --output "digests/$DATE.$EXT"

      - name: Upload digest as artifact
        uses: actions/upload-artifact@v4
        with:
          name: weekly-digest
          path: digests/*
          retention-days: 90

      - name: Display digest location
        run: |
          echo "âœ… Digest generated successfully!"
          echo "ðŸ“¥ Download it from the 'Artifacts' section below"
          echo "ðŸ“„ File: digests/$(date +%Y-%m-%d).md"
